<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¡œë´‡ ì¸í„°ë·° ë° ì•„ì´ë””ì–´ ë…¸íŠ¸</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ê¸€ê¼´ì„ Interë¡œ ì„¤ì •í•˜ê³ , í•œêµ­ì–´ëŠ” ë§‘ì€ ê³ ë”• ë“±ìœ¼ë¡œ í‘œì‹œë˜ë„ë¡ Fallback ì„¤ì • */
        body {
            font-family: 'Inter', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f7f9fb;
            color: #333;
        }
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ê³ ì • í¬ê¸° ë° ìŠ¤í¬ë¡¤ ì„¤ì • */
        .main-container {
            max-width: 1024px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        /* ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        /* ëª¨ë‹¬ ë°°ê²½ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        /* ëª¨ë‹¬ ë‚´ìš© */
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="selection:bg-indigo-200">
    <div id="app" class="main-container">

        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="spinner"></div>
            <p class="text-white ml-3 text-lg">AI ì„œë²„ ë°°í¬ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ 5ë¶„)</p>
        </div>
        
        <!-- 1. Persona Selection Screen -->
        <section id="persona-selection" class="flex flex-col items-center justify-center min-h-screen p-4">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-6">ë‚˜ í˜¼ì ì‚¬ëŠ” ì´ì›ƒì—ê²Œ ë¬¼ì–´ë´!</h1>
            <p class="text-gray-600 mb-8 text-xl">ë¨¼ì €, í•™ìƒ ì´ë¦„ê³¼ ì¸í„°ë·°í•  ì´ì›ƒ í•œ ë¶„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
            
            <!-- ì´ë¦„ ì…ë ¥ í•„ë“œ -->
            <div class="w-full max-w-lg mb-8 p-6 bg-white shadow-xl rounded-xl border border-indigo-200">
                <label for="student-name" class="block text-lg font-medium text-gray-700 mb-2">
                    í•™ìƒ ì´ë¦„ (ì˜ˆ: ê¹€OO)
                </label>
                <input type="text" id="student-name" placeholder="ì—¬ê¸°ì— ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg"
                       oninput="saveStudentName(this.value)">
                <p id="name-feedback" class="text-sm text-red-500 mt-2 hidden">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!</p>
            </div>


            <!-- í˜ë¥´ì†Œë‚˜ ì„ íƒ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
                <!-- ë‚˜ë˜ (20ëŒ€ ëŒ€í•™ìƒ) -->
                <button onclick="startInterview('ë‚˜ë˜', '20ëŒ€ ë‚˜ë˜', 'ì—´ì •ì ì´ì§€ë§Œ ì¼ìƒ ê´€ë¦¬ê°€ ì–´ë ¤ìš´ ëŒ€í•™ìƒ', '#6366f1')"
                        class="p-6 bg-white rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.03] border-4 border-transparent hover:border-indigo-500">
                    <div class="w-16 h-16 mx-auto bg-indigo-200 rounded-full flex items-center justify-center mb-4 text-3xl">ğŸ§‘ğŸ»â€ğŸ“</div>
                    <h2 class="text-xl font-bold text-indigo-700">20ëŒ€ ë‚˜ë˜</h2>
                    <p class="text-sm text-gray-500 mt-1">í•™ì—…ê³¼ ì¼ìƒ ê´€ë¦¬ë¥¼ ë³‘í–‰í•˜ëŠ” ëŒ€í•™ìƒ</p>
                </button>

                <!-- ê¸°ì•ˆ (30ëŒ€ íšŒì‚¬ì›) -->
                <button onclick="startInterview('ê¸°ì•ˆ', '30ëŒ€ ê¸°ì•ˆ', 'ì„±ê³¼ ì••ë°•ì— ì‹œë‹¬ë¦¬ëŠ” ë°”ìœ íšŒì‚¬ì›', '#10b981')"
                        class="p-6 bg-white rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.03] border-4 border-transparent hover:border-emerald-500">
                    <div class="w-16 h-16 mx-auto bg-emerald-200 rounded-full flex items-center justify-center mb-4 text-3xl">ğŸ‘¨ğŸ»â€ğŸ’¼</div>
                    <h2 class="text-xl font-bold text-emerald-700">30ëŒ€ ê¸°ì•ˆ</h2>
                    <p class="text-sm text-gray-500 mt-1">ì„±ê³¼ì™€ ìê¸°ê³„ë°œì— ì§‘ì¤‘í•˜ëŠ” íšŒì‚¬ì›</p>
                </button>

                <!-- í˜„ë¬´ í• ë¨¸ë‹ˆ (70ëŒ€ ë…ê±° ë…¸ì¸) -->
                <button onclick="startInterview('í˜„ë¬´ í• ë¨¸ë‹ˆ', '70ëŒ€ í˜„ë¬´ í• ë¨¸ë‹ˆ', 'ê±´ê°• ê´€ë¦¬ì™€ ì™¸ë¡œì›€ì— ì·¨ì•½í•œ ë…ê±° ë…¸ì¸', '#f59e0b')"
                        class="p-6 bg-white rounded-xl shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-[1.03] border-4 border-transparent hover:border-amber-500">
                    <div class="w-16 h-16 mx-auto bg-amber-200 rounded-full flex items-center justify-center mb-4 text-3xl">ğŸ‘µğŸ»</div>
                    <h2 class="text-xl font-bold text-amber-700">70ëŒ€ í˜„ë¬´ í• ë¨¸ë‹ˆ</h2>
                    <p class="text-sm text-gray-500 mt-1">ê±´ê°• ê´€ë¦¬ì™€ ì™¸ë¡œì›€ ê´€ë¦¬ í•„ìš”í•œ ë…¸ì¸</p>
                </button>
            </div>

            <!-- êµì‚¬ìš© ëŒ€ì‹œë³´ë“œ ë° ì•± ì„¤ëª…ì„œ ë²„íŠ¼ -->
            <div class="mt-10 w-full max-w-lg flex flex-col items-center space-y-4">
                <!-- ìˆœì„œ ë³€ê²½: ì•± ì„¤ëª…ì„œê°€ ë¨¼ì € ì˜¤ë„ë¡ í•¨ -->
                <button id="show-guide-btn" onclick="showGuideModal()"
                        class="w-full px-6 py-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-600 transition duration-150">
                    ì•± ì‚¬ìš© ì„¤ëª…ì„œ ë³´ê¸°
                </button>
                <button id="teacher-dashboard-btn" onclick="showDashboardLogin()"
                        class="w-full px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-lg hover:bg-gray-600 transition duration-150">
                    êµì‚¬ìš© í™œë™ í™•ì¸ (í¬íŠ¸í´ë¦¬ì˜¤ ë³´ê¸°)
                </button>
            </div>
        </section>

        <!-- 2. Interview Screen -->
        <section id="interview-screen" class="hidden flex-col md:flex-row gap-6 p-4">
            
            <!-- ì™¼ìª½: ì±„íŒ… ë° ì•„ì´ë””ì–´ ìš”ì•½ ì˜ì—­ (ëª¨ë°”ì¼ì—ì„œ 100% ì°¨ì§€) -->
            <div class="w-full md:w-2/3 flex flex-col bg-white rounded-2xl shadow-xl p-4 md:p-6 order-2 md:order-1">
                <div class="flex items-center justify-between border-b pb-3 mb-4">
                    <h2 id="interview-title" class="text-2xl font-bold text-gray-700 flex items-center">
                        <span id="persona-emoji" class="text-3xl mr-2"></span>
                        <span id="persona-name"></span>ë‹˜ê³¼ì˜ ì¸í„°ë·°
                    </h2>
                    <span id="question-count" class="text-xl font-semibold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full"></span>
                </div>

                <!-- ì±„íŒ… ì˜ì—­ -->
                <div id="chat-messages" class="chat-container flex-grow space-y-4 mb-4">
                    <!-- ì´ˆê¸° ë©”ì‹œì§€ ë° ì±„íŒ… ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
                </div>

                <!-- ì•„ì´ë””ì–´ ìš”ì•½ (ì¸í„°ë·° ì¢…ë£Œ ì‹œ í‘œì‹œ) -->
                <div id="summary-area" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-bold text-yellow-800 mb-2">ğŸŒŸ ì¸í„°ë·° ìš”ì•½ (ë¡œë´‡ ì•„ì´ë””ì–´ ê·¼ê±°)</h3>
                    <div id="summary-content" class="text-gray-700 text-sm space-y-1"></div>
                </div>

                <!-- ì§ˆë¬¸ ì…ë ¥ ì°½ -->
                <div id="input-area" class="flex flex-col mt-4 pt-4 border-t">
                    <div class="flex space-x-2 mb-2">
                        <button id="suggest-btn" class="flex-shrink-0 px-4 py-2 text-sm bg-indigo-100 text-indigo-700 font-medium rounded-lg hover:bg-indigo-200 transition duration-150">
                            ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ ğŸ’¡
                        </button>
                        <div id="suggested-questions" class="flex flex-wrap gap-2 hidden">
                            <!-- ì¶”ì²œ ì§ˆë¬¸ ë²„íŠ¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
                        </div>
                    </div>
                    <div class="flex">
                        <input type="text" id="user-input" placeholder="ì´ì›ƒì—ê²Œ ì§ˆë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì´ 8íšŒ ì§ˆë¬¸ ê°€ëŠ¥)"
                               class="flex-grow px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500"
                               onkeypress="handleKeyPress(event)">
                        <button id="send-btn" onclick="sendMessage()"
                                class="flex-shrink-0 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-r-lg hover:bg-indigo-700 transition duration-150">
                            ì§ˆë¬¸í•˜ê¸°
                        </button>
                    </div>
                    <p id="limit-message" class="text-sm text-red-500 mt-2 hidden">âš ï¸ ì§ˆë¬¸ íšŸìˆ˜(8íšŒ)ë¥¼ ì´ˆê³¼í•˜ì—¬ ì•„ì´ë””ì–´ ë…¸íŠ¸ ì‘ì„± ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>
                </div>

            </div>

            <!-- ì˜¤ë¥¸ìª½: ì•„ì´ë””ì–´ ë…¸íŠ¸ ì˜ì—­ (ëª¨ë°”ì¼ì—ì„œ 100% ì°¨ì§€) -->
            <div id="note-area" class="w-full md:w-1/3 flex flex-col bg-white rounded-2xl shadow-xl p-4 md:p-6 order-1 md:order-2">
                <h3 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">ë‚˜ì˜ ë¡œë´‡ ì•„ì´ë””ì–´ ë…¸íŠ¸ ğŸ“</h3>
                <textarea id="idea-note" placeholder="ì¸í„°ë·°ë¥¼ ë“¤ìœ¼ë©´ì„œ ë– ì˜¤ë¥¸ ë¡œë´‡ ì•„ì´ë””ì–´ë‚˜ í•´ê²°ì±…ì„ ììœ ë¡­ê²Œ ë©”ëª¨í•˜ì„¸ìš”. (ìë™ ì €ì¥ë¨)"
                          class="flex-grow w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 h-64 md:h-auto"
                          oninput="saveIdeaNote()"
                          ></textarea>
                <button id="save-idea-btn" onclick="saveFinalIdea()"
                        class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 disabled:opacity-50"
                        disabled>
                    ì•„ì´ë””ì–´ ì €ì¥ ë° ì œì¶œ
                </button>
                <button id="back-to-home-btn" onclick="showPersonaSelection()"
                        class="w-full px-6 py-3 mt-2 bg-gray-400 text-white font-semibold rounded-lg shadow-lg hover:bg-gray-500 transition duration-150">
                    ë‹¤ë¥¸ ì´ì›ƒ ì„ íƒí•˜ê¸° (í™ˆìœ¼ë¡œ)
                </button>
            </div>
        </section>

        <!-- 3. Dashboard Login Screen -->
        <section id="dashboard-login" class="hidden flex-col items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md p-8 bg-white shadow-2xl rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">êµì‚¬ìš© í™œë™ í™•ì¸</h2>
                <input type="password" id="dashboard-password" placeholder="ì„ ìƒë‹˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (0000)"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4"
                       onkeypress="handleDashboardKeyPress(event)">
                <button onclick="loginDashboard()"
                        class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                    ë¡œê·¸ì¸
                </button>
                <p id="login-error" class="text-sm text-red-500 mt-3 text-center hidden">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <button onclick="showPersonaSelection()"
                        class="w-full px-6 py-3 mt-4 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition duration-150">
                    í•™ìƒ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </section>

        <!-- 4. Teacher Dashboard Screen -->
        <section id="teacher-dashboard" class="hidden flex-col p-4">
            <div class="flex items-center justify-between border-b pb-3 mb-6">
                <h2 class="text-3xl font-bold text-indigo-700">ì œì¶œëœ ë¡œë´‡ ì•„ì´ë””ì–´ ëŒ€ì‹œë³´ë“œ ğŸ¤–</h2>
                <button onclick="showPersonaSelection()"
                        class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
            
            <div class="mb-4 flex space-x-4">
                <button id="filter-all" onclick="filterIdeas('all')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow transition duration-150">ì „ì²´ ë³´ê¸°</button>
                <button id="filter-ë‚˜ë˜" onclick="filterIdeas('ë‚˜ë˜')" class="px-4 py-2 bg-white text-gray-700 rounded-lg shadow transition duration-150 hover:bg-gray-100">20ëŒ€ ë‚˜ë˜</button>
                <button id="filter-ê¸°ì•ˆ" onclick="filterIdeas('ê¸°ì•ˆ')" class="px-4 py-2 bg-white text-gray-700 rounded-lg shadow transition duration-150 hover:bg-gray-100">30ëŒ€ ê¸°ì•ˆ</button>
                <button id="filter-í˜„ë¬´ í• ë¨¸ë‹ˆ" onclick="filterIdeas('í˜„ë¬´ í• ë¨¸ë‹ˆ')" class="px-4 py-2 bg-white text-gray-700 rounded-lg shadow transition duration-150 hover:bg-gray-100">70ëŒ€ í˜„ë¬´ í• ë¨¸ë‹ˆ</button>
            </div>

            <div id="ideas-list" class="space-y-6">
                <!-- ì œì¶œëœ ì•„ì´ë””ì–´ê°€ ì—¬ê¸°ì— ë¡œë“œë¨ -->
                <p class="text-gray-500">ì œì¶œëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>

    </div>

    <!-- ì•± ì‚¬ìš© ì„¤ëª…ì„œ ëª¨ë‹¬ -->
    <div id="guide-modal" class="modal-backdrop" onclick="closeGuideModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-2xl font-extrabold text-indigo-700">ì•± ì‚¬ìš© ì„¤ëª…ì„œ ğŸ¤–</h2>
                <button onclick="closeGuideModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>

            <div class="space-y-6 text-gray-700">
                <h3 class="text-xl font-bold text-gray-800">1. ì´ ì•±ì˜ ëª©ì ì€ ë¬´ì—‡ì¸ê°€ìš”?</h3>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li>**ê³µê° ë° ë¬¸ì œ ì •ì˜:** 1ì¸ ê°€êµ¬ ì´ì›ƒë“¤ì˜ êµ¬ì²´ì ì¸ ì¼ìƒê³¼ ê·¸ë“¤ì´ ê²ªëŠ” **ì§„ì§œ ë¶ˆí¸í•¨**ì— ëŒ€í•´ ê³µê°í•˜ë©° ì¸í„°ë·°í•©ë‹ˆë‹¤.</li>
                    <li>**ë¡œë´‡ ì•„ì´ë””ì–´ êµ¬ìƒ:** ì¸í„°ë·°ë¥¼ í†µí•´ ì´ì›ƒì˜ ì–´ë ¤ì›€ì„ ëª…í™•íˆ ì •ì˜í•˜ê³ , ì´ ë¬¸ì œë¥¼ í•´ê²°í•  **ë¡œë´‡ ì•„ì´ë””ì–´**ë¥¼ êµ¬ìƒí•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.</li>
                </ul>

                <h3 class="text-xl font-bold text-gray-800">2. ì¸í„°ë·° ì§„í–‰ ë°©ë²•</h3>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li>**ì´ë¦„ ì…ë ¥ (í•„ìˆ˜):** ê°€ì¥ ë¨¼ì € **í•™ìƒì˜ ì´ë¦„**ì„ ì…ë ¥í•©ë‹ˆë‹¤. ì´ ì´ë¦„ìœ¼ë¡œ ì•„ì´ë””ì–´ê°€ ì €ì¥ ë° ì œì¶œë©ë‹ˆë‹¤.</li>
                    <li>**ì´ì›ƒ ì„ íƒ:** 20ëŒ€ 'ë‚˜ë˜', 30ëŒ€ 'ê¸°ì•ˆ', 70ëŒ€ 'í˜„ë¬´ í• ë¨¸ë‹ˆ' ì¤‘ í•œ ë¶„ì„ ì„ íƒí•©ë‹ˆë‹¤.</li>
                    <li>**ì§ˆë¬¸í•˜ê¸°:** ê¶ê¸ˆí•œ ì ì„ ì±„íŒ…ì°½ì— ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, **`ìì£¼ ë¬»ëŠ” ì§ˆë¬¸`** ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì§ˆë¬¸í•©ë‹ˆë‹¤.</li>
                    <li>**ì´ 8íšŒ ì§ˆë¬¸:** ì¸í„°ë·°ëŠ” ì´ì›ƒì—ê²Œ **ì´ 8íšŒ** ì§ˆë¬¸ì„ í•˜ë©´ ìë™ìœ¼ë¡œ ì¢…ë£Œë˜ê³ , ì´ì›ƒì´ ê²ªëŠ” ì–´ë ¤ì›€ 3ê°€ì§€ê°€ ìš”ì•½ë˜ì–´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</li>
                </ul>

                <h3 class="text-xl font-bold text-gray-800">3. ì•„ì´ë””ì–´ ë…¸íŠ¸ ì‘ì„± (ê°€ì¥ ì¤‘ìš”!)</h3>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li>**ì‹¤ì‹œê°„ ë©”ëª¨:** ì¸í„°ë·° ì¤‘ ë– ì˜¤ë¥¸ ì•„ì´ë””ì–´ë¥¼ ì˜¤ë¥¸ìª½ **`ë‚˜ì˜ ë¡œë´‡ ì•„ì´ë””ì–´ ë…¸íŠ¸`**ì— ì¦‰ì‹œ ë©”ëª¨í•˜ì„¸ìš”.</li>
                    <li>**ìë™ ì €ì¥ ê¸°ëŠ¥:** ë…¸íŠ¸ ë‚´ìš©ì€ **ìë™ìœ¼ë¡œ ì„ì‹œ ì €ì¥**ë©ë‹ˆë‹¤.</li>
                    <li>**ê³µì‹ ì œì¶œ:** ì•„ì´ë””ì–´ ì‘ì„±ì„ ë§ˆì³¤ë‹¤ë©´ **`ì•„ì´ë””ì–´ ì €ì¥ ë° ì œì¶œ`** ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„ ìƒë‹˜ê»˜ ì œì¶œí•©ë‹ˆë‹¤.</li>
                </ul>

                <h3 class="text-xl font-bold text-gray-800">4. êµì‚¬ í™œë™ í™•ì¸ (ì„ ìƒë‹˜ë§Œ ì ‘ê·¼ ê°€ëŠ¥)</h3>
                <ul class="list-disc list-inside space-y-2 ml-4">
                    <li>í™ˆ í™”ë©´ ì•„ë˜ìª½ **`êµì‚¬ìš© í™œë™ í™•ì¸`** ë²„íŠ¼ì„ ì´ìš©í•©ë‹ˆë‹¤.</li>
                    <li>(ì ‘ê·¼ì„ ìœ„í•´ì„œëŠ” ë¹„ë°€ë²ˆí˜¸ `0000`ì´ í•„ìš”í•©ë‹ˆë‹¤.)</li>
                </ul>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Custom Firebase Configuration ---
        // ì´ ì½”ë“œë¥¼ GitHub Pagesì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´, __app_id ë“±ì˜ Canvas ì „ì—­ ë³€ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ,
        // ì—¬ê¸°ì— ì„ ìƒë‹˜ì˜ ì‹¤ì œ Firebase ì„¤ì •ê°’ì„ ë„£ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

        const CUSTOM_FIREBASE_CONFIG = {
            // ì—¬ê¸°ì— ì„ ìƒë‹˜ì˜ ì‹¤ì œ Firebase config ê°’ì„ ë„£ìœ¼ì„¸ìš”.
            // ì˜ˆì‹œ: apiKey, authDomain, projectId ë“±
            apiKey: "AIzaSyBMQMydcg_lP2t_TAhdVWYUtSgTMDmKwmE", // ì„ ìƒë‹˜ì˜ ì‹¤ì œ API Key
            authDomain: "airobot-3d894.firebaseapp.com",
            projectId: "airobot-3d894",
            storageBucket: "airobot-3d894.firebasestorage.app",
            messagingSenderId: "521833072411",
            appId: "1:521833072411:web:26e946cd7b26cb6af2f5be",
            measurementId: "G-Z55XBFJRGW" 
        };

        // --- Firebase Configuration and Initialization ---
        // Canvas í™˜ê²½ ë³€ìˆ˜ ìœ ë¬´ì— ë”°ë¼ ì‚¬ìš©í•  configë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'robot-interview-app-2025'; // GitHubìš© ê³ ì • ID
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : CUSTOM_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        // Global variables for Firebase services
        let db = null;
        let auth = null;
        let functions = null;
        let userId = null;
        let isAuthReady = false;

        // --- App State Variables ---
        let currentPersona = '';
        let currentPersonaTitle = '';
        let interviewHistory = [];
        let questionLimit = 8;
        let totalQuestionsAsked = 0;
        let interviewActive = false;
        let studentName = localStorage.getItem('studentName') || '';

        // UI elements
        const ui = {
            selectionScreen: document.getElementById('persona-selection'),
            interviewScreen: document.getElementById('interview-screen'),
            dashboardLogin: document.getElementById('dashboard-login'),
            teacherDashboard: document.getElementById('teacher-dashboard'),
            studentNameInput: document.getElementById('student-name'),
            nameFeedback: document.getElementById('name-feedback'),
            interviewTitle: document.getElementById('interview-title'),
            personaName: document.getElementById('persona-name'),
            personaEmoji: document.getElementById('persona-emoji'),
            questionCount: document.getElementById('question-count'),
            chatMessages: document.getElementById('chat-messages'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            suggestBtn: document.getElementById('suggest-btn'),
            suggestedQuestions: document.getElementById('suggested-questions'),
            ideaNote: document.getElementById('idea-note'),
            saveIdeaBtn: document.getElementById('save-idea-btn'),
            limitMessage: document.getElementById('limit-message'),
            summaryArea: document.getElementById('summary-area'),
            summaryContent: document.getElementById('summary-content'),
            loadingOverlay: document.getElementById('loading-overlay'),
            ideasList: document.getElementById('ideas-list'),
            guideModal: document.getElementById('guide-modal')
        };

        // --- Firebase Initialization and Authentication ---

        const initializeFirebase = async () => {
            // Github í™˜ê²½ì—ì„œ configê°€ ì—†ëŠ” ê²½ìš° (ì˜ˆ: projectIDê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°) ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
            if (!firebaseConfig || !firebaseConfig.projectId) { 
                console.error("Firebase config is missing or incomplete.");
                document.getElementById('loading-overlay').innerHTML = `<p class="text-white text-xl">Firebase ì„¤ì • ì˜¤ë¥˜: ì•± êµ¬ì„± ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (CUSTOM_FIREBASE_CONFIG í™•ì¸ í•„ìš”)</p>`;
                document.getElementById('loading-overlay').classList.remove('hidden');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                functions = getFunctions(app, 'asia-northeast3'); // Cloud Functions ì§€ì—­ ì„¤ì • (ì„œìš¸)

                // Optional: Enable debug logging for Firestore
                // setLogLevel('debug');

                // Check for initial auth token and sign in
                if (initialAuthToken) {
                    await setPersistence(auth, browserSessionPersistence);
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if token is missing (useful for local development)
                    await setPersistence(auth, browserSessionPersistence);
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Check for saved name and show the correct screen
                        if (studentName) {
                            ui.studentNameInput.value = studentName;
                        }
                        showPersonaSelection();
                        
                        // Load persistent data once authenticated
                        loadInterviewHistory();
                        loadIdeaNote();
                    } else {
                        console.log("No user signed in.");
                        isAuthReady = true;
                        // Still show selection, but data loading will rely on anonymous ID if needed.
                        showPersonaSelection();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                const errorMessage = `FirebaseError: ${error.message}`;
                document.getElementById('loading-overlay').innerHTML = `<p class="text-white text-xl">í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ${errorMessage}</p>`;
                document.getElementById('loading-overlay').classList.remove('hidden');
            }
        };

        // --- Data Path Helpers ---

        /**
         * Get the base path for user-specific data in Firestore.
         * Structure: /artifacts/{appId}/users/{userId}/{collectionName}
         * @param {string} collectionName The name of the collection (e.g., 'interview_history')
         * @returns {string} The full Firestore path
         */
        const getUserDataPath = (collectionName) => {
            if (!userId) {
                // Should not happen if isAuthReady is true, but as a fallback
                return `artifacts/${appId}/users/anonymous-id/`;
            }
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        };

        /**
         * Get the base path for public, shared data in Firestore (used for dashboard).
         * Structure: /artifacts/{appId}/public/data/{collectionName}
         * @param {string} collectionName The name of the collection (e.g., 'final_ideas')
         * @returns {string} The full Firestore path
         */
        const getPublicDataPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        };


        // --- UI State Management ---

        const showSection = (sectionId) => {
            const sections = [ui.selectionScreen, ui.interviewScreen, ui.dashboardLogin, ui.teacherDashboard];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                    section.classList.add('flex'); // Show
                } else {
                    section.classList.add('hidden');
                    section.classList.remove('flex'); // Hide
                }
            });
            // Scroll to the top when switching screens
            window.scrollTo(0, 0);
        };

        const showPersonaSelection = () => {
            showSection('persona-selection');
            // Ensure name is visible if saved
            if (studentName) {
                ui.studentNameInput.value = studentName;
            }
        };

        const showInterviewScreen = () => {
            showSection('interview-screen');
            // Mobile: Ensure note area is below chat
            if (window.innerWidth < 768) {
                document.getElementById('note-area').classList.add('order-1');
                document.getElementById('note-area').classList.remove('order-2');
                document.getElementById('interview-screen').classList.add('flex-col');
                document.getElementById('interview-screen').classList.remove('md:flex-row');
            } else {
                 document.getElementById('note-area').classList.remove('order-1');
                 document.getElementById('note-area').classList.add('order-2');
                 document.getElementById('interview-screen').classList.add('md:flex-row');
                 document.getElementById('interview-screen').classList.remove('flex-col');
            }
        };

        const showDashboardLogin = () => {
            showSection('dashboard-login');
            document.getElementById('dashboard-password').value = ''; // Clear password field
            document.getElementById('login-error').classList.add('hidden');
        };

        const showTeacherDashboard = () => {
            showSection('teacher-dashboard');
            // Load and display data when dashboard is opened
            loadDashboardData();
        };

        // --- Student Name and Persistence ---

        window.saveStudentName = (name) => {
            studentName = name.trim();
            localStorage.setItem('studentName', studentName);
            if (studentName) {
                ui.nameFeedback.classList.add('hidden');
            }
        };

        // --- Interview Flow Logic ---

        window.startInterview = (persona, title, description, color) => {
            if (!studentName) {
                ui.nameFeedback.classList.remove('hidden');
                ui.studentNameInput.focus();
                return;
            }

            currentPersona = persona;
            currentPersonaTitle = title;
            interviewActive = true;
            totalQuestionsAsked = 0;
            
            // UI setup
            ui.personaName.textContent = title;
            ui.personaEmoji.textContent = getPersonaEmoji(persona);
            ui.questionCount.textContent = `0/${questionLimit}íšŒ`;
            ui.chatMessages.innerHTML = ''; // Clear chat
            ui.summaryArea.classList.add('hidden');
            ui.limitMessage.classList.add('hidden');
            ui.saveIdeaBtn.disabled = true; // Disable save until interview is done
            
            // Re-enable chat input area
            ui.userInput.disabled = false;
            ui.sendBtn.disabled = false;
            ui.userInput.placeholder = "ì´ì›ƒì—ê²Œ ì§ˆë¬¸í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì´ 8íšŒ ì§ˆë¬¸ ê°€ëŠ¥)";
            
            // Load history and note for this persona
            loadInterviewHistory(persona);
            loadIdeaNote(persona);
            
            // Initial AI greeting (if no history)
            if (interviewHistory.length === 0) {
                 displayMessage('system', `${title}ë‹˜ê³¼ì˜ ì¸í„°ë·°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ${description}ë‹˜ì€ ì–´ë–¤ ì¼ìƒì„ ë³´ë‚´ì‹œëŠ”ì§€ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.`, color);
            } else {
                 // If history exists, just show the history
                 interviewHistory.forEach(msg => displayMessage(msg.role, msg.text, color, false));
            }

            showInterviewScreen();
            updateQuestionCount();
            setupSuggestedQuestions(persona);
        };

        const getPersonaEmoji = (persona) => {
            switch (persona) {
                case 'ë‚˜ë˜': return 'ğŸ§‘ğŸ»â€ğŸ“';
                case 'ê¸°ì•ˆ': return 'ğŸ‘¨ğŸ»â€ğŸ’¼';
                case 'í˜„ë¬´ í• ë¨¸ë‹ˆ': return 'ğŸ‘µğŸ»';
                default: return 'ğŸ¤–';
            }
        };

        const setupSuggestedQuestions = (persona) => {
            ui.suggestedQuestions.innerHTML = '';
            const questions = {
                'ë‚˜ë˜': ['í•™êµ ìƒí™œì€ ì–´ë–¤ê°€ìš”?', 'ì£¼ë¡œ ì–´ë””ì„œ ì‹ì‚¬ë¥¼ í•´ê²°í•˜ë‚˜ìš”?', 'í•˜ë£¨ ì¤‘ ê°€ì¥ í˜ë“  ì‹œê°„ì€ ì–¸ì œì¸ê°€ìš”?'],
                'ê¸°ì•ˆ': ['ì§ì¥ ìƒí™œì˜ ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ë¬´ì—‡ì¸ê°€ìš”?', 'í‡´ê·¼ í›„ ì£¼ë¡œ ë¬´ì—‡ì„ í•˜ì‹œë‚˜ìš”?', 'ì£¼ë§ì—ëŠ” ë³´í†µ ì–´ë–»ê²Œ ì‹œê°„ì„ ë³´ë‚´ì‹œë‚˜ìš”?'],
                'í˜„ë¬´ í• ë¨¸ë‹ˆ': ['ê±´ê°• ê´€ë¦¬ëŠ” ì–´ë–»ê²Œ í•˜ì‹œë‚˜ìš”?', 'ê°€ì¥ ì™¸ë¡œì›€ì„ ëŠë‚„ ë•ŒëŠ” ì–¸ì œì¸ê°€ìš”?', 'ì¥ì„ ë³´ê±°ë‚˜ ì§‘ì•ˆì¼ í•  ë•Œ ë¶ˆí¸í•¨ì€ ì—†ìœ¼ì‹ ê°€ìš”?']
            };

            questions[persona].forEach(q => {
                const btn = document.createElement('button');
                btn.textContent = q;
                btn.className = 'px-3 py-1 text-xs bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition duration-150';
                btn.onclick = () => {
                    ui.userInput.value = q;
                    sendMessage();
                };
                ui.suggestedQuestions.appendChild(btn);
            });
            
            // Toggle suggestions on button click
            ui.suggestBtn.onclick = () => {
                ui.suggestedQuestions.classList.toggle('hidden');
            };
        };

        const updateQuestionCount = () => {
            totalQuestionsAsked = interviewHistory.filter(msg => msg.role === 'user').length;
            ui.questionCount.textContent = `${totalQuestionsAsked}/${questionLimit}íšŒ`;

            if (totalQuestionsAsked >= questionLimit && interviewActive) {
                // End interview automatically
                interviewActive = false;
                ui.userInput.disabled = true;
                ui.sendBtn.disabled = true;
                ui.userInput.placeholder = "ì¸í„°ë·°ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìš”ì•½ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                ui.suggestedQuestions.classList.add('hidden');
                ui.limitMessage.classList.remove('hidden');
                
                // Get final summary from AI
                getFinalSummary();
            }
        };

        // --- Chat UI Functions ---

        const displayMessage = (role, text, color, isNew = true) => {
            const messageElement = document.createElement('div');
            const isUser = role === 'user';
            
            messageElement.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-xl shadow-md ${
                isUser 
                ? 'bg-indigo-500 text-white rounded-br-none' 
                : 'bg-white text-gray-800 rounded-tl-none border border-gray-200'
            }`;
            bubble.innerHTML = text.replace(/\n/g, '<br>'); // Preserve line breaks

            messageElement.appendChild(bubble);
            ui.chatMessages.appendChild(messageElement);

            if (isNew) {
                interviewHistory.push({ role: role, text: text });
                // Only save history if the user is authenticated (to prevent constant writes for anonymous users)
                if (isAuthReady && userId) {
                    saveInterviewHistory();
                }
            }
            
            // Auto-scroll to the bottom
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
        };

        const addLoadingIndicator = () => {
            const loadingElement = document.createElement('div');
            loadingElement.id = 'loading-indicator';
            loadingElement.className = 'flex justify-start mb-4';
            loadingElement.innerHTML = `
                <div class="px-4 py-3 rounded-xl bg-white text-gray-800 rounded-tl-none border border-gray-200 flex items-center space-x-2">
                    <div class="spinner border-indigo-400 border-t-transparent w-4 h-4"></div>
                    <span>ë‹µë³€ ìƒê° ì¤‘...</span>
                </div>
            `;
            ui.chatMessages.appendChild(loadingElement);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
        };

        const removeLoadingIndicator = () => {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        // --- Main Interaction Functions ---

        window.handleKeyPress = (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        };

        window.sendMessage = async () => {
            const userText = ui.userInput.value.trim();
            if (!userText || !interviewActive) return;

            // 1. Display user message
            displayMessage('user', userText, 'indigo');
            ui.userInput.value = ''; // Clear input

            // 2. Show loading indicator
            addLoadingIndicator();

            try {
                // 3. Call Cloud Function securely
                const result = await callGeminiApi({
                    userPrompt: userText,
                    persona: currentPersona,
                    history: interviewHistory.slice(-5) // Send last 5 messages for context
                });

                // 4. Remove loading indicator
                removeLoadingIndicator();

                if (result.error) {
                    displayMessage('system', `ì£„ì†¡í•©ë‹ˆë‹¤. ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${result.error}`, 'red');
                    return;
                }

                // 5. Display AI response and update count
                displayMessage('system', result.response, getPersonaColor(currentPersona));
                updateQuestionCount();

            } catch (error) {
                removeLoadingIndicator();
                console.error("Gemini API call failed:", error);
                displayMessage('system', `ì£„ì†¡í•©ë‹ˆë‹¤. ì„œë²„ í†µì‹  ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`, 'red');
            }
        };
        
        const getPersonaColor = (persona) => {
             switch (persona) {
                case 'ë‚˜ë˜': return '#6366f1'; // indigo
                case 'ê¸°ì•ˆ': return '#10b981'; // emerald
                case 'í˜„ë¬´ í• ë¨¸ë‹ˆ': return '#f59e0b'; // amber
                default: return '#333';
            }
        };
        
        // --- Functions for Interview Summary ---

        const getFinalSummary = async () => {
            // Send final history to AI to extract key problems
            const summaryPrompt = `Based on the interview history below with ${currentPersonaTitle}, please summarize the THREE most significant problems or difficulties they face in their daily life that a robot could potentially solve.
            Format your response as a numbered list (1. Problem, 2. Problem, 3. Problem) without any introductory or concluding sentences.`;

            // 1. Show loading indicator for summary
            const summaryLoading = document.createElement('div');
            summaryLoading.id = 'summary-loading';
            summaryLoading.className = 'flex justify-start mb-4';
            summaryLoading.innerHTML = `
                <div class="px-4 py-3 rounded-xl bg-white text-gray-800 rounded-tl-none border border-gray-200 flex items-center space-x-2">
                    <div class="spinner border-yellow-400 border-t-transparent w-4 h-4"></div>
                    <span>ì¸í„°ë·° ìš”ì•½ ì¤‘...</span>
                </div>
            `;
            ui.chatMessages.appendChild(summaryLoading);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;

            try {
                 const result = await callGeminiApi({
                    userPrompt: summaryPrompt,
                    persona: currentPersona,
                    history: interviewHistory // Send full history for summary
                });
                
                // Remove loading indicator
                document.getElementById('summary-loading')?.remove();

                if (result.error) {
                    ui.summaryContent.textContent = `ìš”ì•½ ì˜¤ë¥˜: ì„œë²„ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${result.error})`;
                } else {
                    // Display summary
                    ui.summaryContent.innerHTML = result.response.replace(/\n/g, '<br>');
                    ui.summaryArea.classList.remove('hidden');
                    ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight; // Scroll to summary
                    ui.saveIdeaBtn.disabled = false; // Enable saving final idea
                }
            } catch (error) {
                document.getElementById('summary-loading')?.remove();
                ui.summaryContent.textContent = `ìš”ì•½ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`;
                console.error("Summary API call failed:", error);
            }
        };
        

        // --- Cloud Functions Call (KEY HIDING MECHANISM) ---
        
        /**
         * Securely calls the deployed Firebase Function which handles the Gemini API key.
         * The key is never exposed to the client.
         */
        const callGeminiApi = async (data) => {
            if (!functions) {
                return { error: "Functions service not initialized." };
            }
            
            // The name of the function deployed in functions/index.js
            const callGemini = httpsCallable(functions, 'callGemini'); 
            
            try {
                // Call the function with the chat data
                const response = await callGemini(data);
                
                // response.data contains the result from the function
                if (response.data.error) {
                     return { error: response.data.error };
                }
                
                return { response: response.data.response };
                
            } catch (error) {
                console.error("Error calling Cloud Function:", error);
                // The error object from the function call is different from a fetch error
                return { error: error.message || "Cloud Function execution failed." };
            }
        };


        // --- Firestore Persistence (History and Note) ---

        // Load data from Firestore for the current user and persona
        const loadInterviewHistory = (persona = currentPersona) => {
             if (!isAuthReady || !userId || !persona) return;
             
             const docRef = doc(db, getUserDataPath('interview_history'), persona);
             
             // Setup real-time listener
             onSnapshot(docRef, (docSnapshot) => {
                 if (docSnapshot.exists()) {
                     const data = docSnapshot.data();
                     interviewHistory = data.history || [];
                     
                     // If on the interview screen, update the UI
                     if (document.getElementById('interview-screen').classList.contains('flex')) {
                          ui.chatMessages.innerHTML = ''; // Clear existing messages
                          
                          // Redisplay messages
                          const color = getPersonaColor(currentPersona);
                          interviewHistory.forEach(msg => displayMessage(msg.role, msg.text, color, false));
                          
                          // Check for completion status
                          updateQuestionCount();
                          if (data.summary) {
                             ui.summaryContent.innerHTML = data.summary.replace(/\n/g, '<br>');
                             ui.summaryArea.classList.remove('hidden');
                             ui.saveIdeaBtn.disabled = false;
                          }
                     }
                 } else {
                     interviewHistory = [];
                 }
             }, (error) => {
                 console.error("Error listening to interview history:", error);
             });
        };
        
        // Save history to Firestore
        const saveInterviewHistory = async () => {
            if (!isAuthReady || !userId || !currentPersona) return;
            try {
                const docRef = doc(db, getUserDataPath('interview_history'), currentPersona);
                // Note: Summary will be saved separately when generated
                await setDoc(docRef, { 
                    history: interviewHistory,
                    lastUpdated: serverTimestamp() 
                }, { merge: true });
            } catch (error) {
                console.error("Error saving interview history:", error);
            }
        };

        // Load idea note from LocalStorage (for quick drafts)
        const loadIdeaNote = (persona = currentPersona) => {
            const noteKey = `ideaNote_${studentName}_${persona}`;
            ui.ideaNote.value = localStorage.getItem(noteKey) || '';
        };
        
        // Save idea note to LocalStorage (real-time save)
        window.saveIdeaNote = () => {
            const noteKey = `ideaNote_${studentName}_${currentPersona}`;
            localStorage.setItem(noteKey, ui.ideaNote.value);
        };
        
        // --- Final Idea Submission ---
        
        window.saveFinalIdea = async () => {
            if (!isAuthReady || !userId || !studentName || ui.saveIdeaBtn.disabled) return;
            
            const finalNote = ui.ideaNote.value.trim();
            const summaryText = ui.summaryContent.textContent.trim();
            
            if (!finalNote || !summaryText) {
                alert("ì•„ì´ë””ì–´ ë…¸íŠ¸ì™€ ì¸í„°ë·° ìš”ì•½ì´ ëª¨ë‘ ìˆì–´ì•¼ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            
            // Disable button during submission
            ui.saveIdeaBtn.disabled = true;
            ui.saveIdeaBtn.textContent = 'ì œì¶œ ì¤‘...';
            
            try {
                // 1. Save summary back to history doc (merge with existing history)
                const historyDocRef = doc(db, getUserDataPath('interview_history'), currentPersona);
                await setDoc(historyDocRef, { summary: summaryText }, { merge: true });

                // 2. Save final idea to public dashboard collection
                const publicCollectionRef = collection(db, getPublicDataPath('final_ideas'));
                // Use a unique ID based on user and persona to prevent duplicates
                const docId = `${userId}_${currentPersona}`; 
                const publicDocRef = doc(publicCollectionRef, docId);
                
                await setDoc(publicDocRef, {
                    studentId: userId,
                    studentName: studentName,
                    persona: currentPersona,
                    personaTitle: currentPersonaTitle,
                    summary: summaryText,
                    ideaNote: finalNote,
                    submittedAt: serverTimestamp()
                }, { merge: true });

                alert("ğŸ‰ ì•„ì´ë””ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ ë° ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! 'ë‹¤ë¥¸ ì´ì›ƒ ì„ íƒí•˜ê¸°' ë²„íŠ¼ìœ¼ë¡œ ëŒì•„ê°€ì„¸ìš”.");
                ui.saveIdeaBtn.textContent = 'ì œì¶œ ì™„ë£Œ âœ…';
                ui.backToHomeBtn.focus();
                
            } catch (error) {
                console.error("Error saving final idea:", error);
                alert("ì•„ì´ë””ì–´ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                ui.saveIdeaBtn.disabled = false;
                ui.saveIdeaBtn.textContent = 'ì•„ì´ë””ì–´ ì €ì¥ ë° ì œì¶œ';
            }
        };


        // --- Teacher Dashboard Logic ---

        window.handleDashboardKeyPress = (event) => {
            if (event.key === 'Enter') {
                loginDashboard();
            }
        };

        window.loginDashboard = () => {
            const password = document.getElementById('dashboard-password').value;
            const correctPassword = '0000'; // Simple password check for demo

            if (password === correctPassword) {
                showTeacherDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        const loadDashboardData = () => {
            if (!isAuthReady) {
                ui.ideasList.innerHTML = `<p class="text-red-500">ì¸ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>`;
                return;
            }
            
            // Query public final_ideas collection
            const ideasCollectionRef = collection(db, getPublicDataPath('final_ideas'));
            
            // Listen for real-time updates
            onSnapshot(query(ideasCollectionRef, orderBy('submittedAt', 'desc')), (snapshot) => {
                let ideas = [];
                snapshot.forEach(doc => {
                    ideas.push(doc.data());
                });
                
                // Store all data globally for filtering
                window.allSubmittedIdeas = ideas; 
                
                // Display the current filtered view (default to 'all')
                filterIdeas(document.querySelector('.dashboard-filter.bg-indigo-600')?.id.replace('filter-', '') || 'all');
                
            }, (error) => {
                console.error("Error loading dashboard data:", error);
                ui.ideasList.innerHTML = `<p class="text-red-500">ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>`;
            });
        };
        
        window.filterIdeas = (persona) => {
            const ideas = window.allSubmittedIdeas || [];
            let filteredIdeas = ideas;

            // Update filter button styles
            document.querySelectorAll('.dashboard-filter').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
            });
            const activeBtn = document.getElementById(`filter-${persona}`);
            if(activeBtn) {
                 activeBtn.classList.add('bg-indigo-600', 'text-white');
                 activeBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
            } else {
                 document.getElementById('filter-all').classList.add('bg-indigo-600', 'text-white');
                 document.getElementById('filter-all').classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
            }


            if (persona !== 'all') {
                filteredIdeas = ideas.filter(idea => idea.persona === persona);
            }
            
            ui.ideasList.innerHTML = ''; // Clear list
            
            if (filteredIdeas.length === 0) {
                ui.ideasList.innerHTML = `<p class="text-gray-500 p-4">ì œì¶œëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            filteredIdeas.forEach(idea => {
                const date = idea.submittedAt ? new Date(idea.submittedAt.toDate()).toLocaleString('ko-KR') : 'ë°©ê¸ˆ ì „';
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 transition hover:shadow-xl';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b pb-2">
                        <h3 class="text-xl font-extrabold text-gray-800">
                            ${idea.studentName} í•™ìƒ 
                            <span class="text-base font-medium text-indigo-600 ml-2">(${idea.personaTitle} ì¸í„°ë·°)</span>
                        </h3>
                        <span class="text-xs text-gray-500">${date}</span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="font-semibold text-sm text-gray-600 mb-1">ğŸ” ìš”ì•½ëœ ì´ì›ƒì˜ 3ëŒ€ ë¬¸ì œ:</p>
                        <div class="bg-gray-50 p-3 rounded text-sm whitespace-pre-wrap">${idea.summary}</div>
                    </div>
                    
                    <div>
                        <p class="font-semibold text-sm text-gray-600 mb-1">ğŸ“ ë¡œë´‡ ì•„ì´ë””ì–´ ë…¸íŠ¸:</p>
                        <div class="bg-indigo-50 p-3 rounded text-sm whitespace-pre-wrap">${idea.ideaNote}</div>
                    </div>
                `;
                ui.ideasList.appendChild(card);
            });
        };
        
        // --- Guide Modal Functions ---

        window.showGuideModal = () => {
            ui.guideModal.style.display = 'flex';
        };

        window.closeGuideModal = (event) => {
            // Check if the click was on the backdrop itself, not the content
            if (!event || event.target.id === 'guide-modal') {
                ui.guideModal.style.display = 'none';
            }
        };
        
        // --- Start App ---

        // Check if the script is being executed in the browser context
        if (typeof window !== 'undefined') {
            initializeFirebase();
        }

    </script>
</body>
</html>
